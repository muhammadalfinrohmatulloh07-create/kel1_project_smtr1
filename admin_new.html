<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PUDDINGKU - Admin Dashboard</title>
  <meta name="description" content="Demo admin dashboard untuk UMKM Puddingku - daftar pesanan, profit, tracking order, dan login admin (static demo).">
  <style>
    :root{
      --bg:#0f1724; --card:#111827; --muted:#9ca3af; --accent:#f97316; --accent-2:#fb923c; --glass: rgba(255,255,255,0.03);
      --success:#10b981; --danger:#ef4444; --surface:#0b1220; --white:#fff;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071024 0%, #071821 50%);color:var(--white);min-height:100vh;transition:background .2s,color .2s}

    /* light mode */
    body.light{
      --bg:#f8fafc; --card:#ffffff; --muted:#6b7280; --accent:#f97316; --accent-2:#fb923c; --glass: rgba(0,0,0,0.03);
      background: linear-gradient(180deg,#ffffff 0%, #f1f5f9 50%);
      color:#0b1220;
    }

    /* Layout */
    .app{display:grid;grid-template-columns:260px 1fr;gap:24px;padding:28px}
    .sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:20px;border-radius:14px;height:calc(100vh - 56px);position:sticky;top:28px}
    body.light .sidebar{background:#ffffff;border:1px solid rgba(0,0,0,0.04);color:#0b1220}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:20px}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700}
    .logo span{font-size:20px}
    .brand h1{margin:0;font-size:18px}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    nav a{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;color:var(--muted);text-decoration:none;margin-bottom:6px}
    nav a.active, nav a:hover{background:var(--glass);color:var(--white)}
    body.light nav a{color:var(--muted)}
    body.light nav a.active, body.light nav a:hover{background:rgba(0,0,0,0.04);color:var(--accent)}

    .main{padding:6px 10px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .header-left{display:flex;gap:12px;align-items:center}
    .search{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;color:var(--white);min-width:360px}
    body.light .search{background:transparent;border:1px solid rgba(0,0,0,0.06);color:#0b1220}
    .user{display:flex;gap:12px;align-items:center}
    .avatar{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#ef9a9a,#f48fb1);display:flex;align-items:center;justify-content:center}

    /* cards */
    .row{display:flex;gap:18px;margin-bottom:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;flex:1}
    body.light .card{background:var(--card);box-shadow: 0 4px 14px rgba(2,6,23,0.04)}
    .kpi{display:flex;justify-content:space-between;align-items:center}
    .kpi .title{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:22px;font-weight:700}

    /* Orders table */
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th, .table td{padding:10px 12px;text-align:left;font-size:14px;border-bottom:1px solid rgba(255,255,255,0.03)}
    body.light .table th, body.light .table td{border-bottom:1px solid rgba(0,0,0,0.06)}
    .table th{color:var(--muted);font-weight:600}
    .status{padding:6px 8px;border-radius:8px;font-weight:600;font-size:13px}
    .status.pending{background:rgba(245,158,11,0.12);color:#f59e0b}
    .status.prep{background:rgba(59,130,246,0.08);color:#3b82f6}
    .status.ship{background:rgba(16,185,129,0.08);color:#10b981}
    .status.cancel{background:rgba(239,68,68,0.08);color:#ef4444}

    .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:var(--accent);color:#111827;font-weight:700;border:none;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white)}
    body.light .btn.ghost{color:#0b1220;border:1px solid rgba(0,0,0,0.06)}

    /* Modal / right panel */
    .drawer{position:fixed;right:18px;top:80px;width:420px;height:calc(100vh - 160px);background-color: #071024;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.6);overflow:auto;display:none}
    .drawer.open{display:block}
    body.light .drawer{background:#fff;color:#111;border:1px solid rgba(0,0,0,0.06)}
    .drawer h3{margin-top:0}

    /* Login screen */
    .login-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,23,0.7), rgba(2,6,23,0.85));backdrop-filter: blur(4px)}
    .login{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:28px;border-radius:12px;width:420px}
    body.light .login{background:#fff;color:#111;border:1px solid rgba(0,0,0,0.06)}
    .login h2{margin:0 0 6px 0}
    .form-row{margin-bottom:12px}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    input[type=text], input[type=password], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)}
    body.light input[type=text], body.light input[type=password], body.light select, body.light textarea{background:transparent;color:#111;border:1px solid rgba(0,0,0,0.08)}

    /* small */
    .muted{color:var(--muted);font-size:13px}
    .order-actions{display:flex;gap:8px;align-items:center}

    /* responsive */
    @media (max-width:900px){.app{grid-template-columns:1fr;}.sidebar{position:relative;height:auto}.search{min-width:0;width:100%}}

    /* settings */
    .settings-layout {display: flex;gap: 24px;}
    .settings-menu {width: 220px;display: flex;flex-direction: column;gap: 8px;}
    .setting-tab {background: rgba(255,255,255,0.04);border: none;padding: 10px;border-radius: 10px;color: #fff;text-align: left;cursor: pointer;transition: .25s;}
    .setting-tab:hover,.setting-tab.active {background: rgba(255,255,255,0.17);}
    .settings-content {flex: 1;padding: 12px 0;}
    .content-item {display: none;animation: fade .25s;}
    .content-item.active {display: block;}
    @keyframes fade {from { opacity: 0;} to   { opacity: 1;}}

    /* product table small */
    #section-products .product-actions button {margin-right:6px}
    #productModal {
      position: fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.5); z-index:9999;
    }
    #productModal .modal-inner {
      width: 520px; max-width:95%; background:var(--card); padding:18px; border-radius:12px;
    }
    body.light #productModal .modal-inner{background:#fff}
    .form-row-inline{display:flex;gap:8px}
    .form-row-inline .col{flex:1}
    img.product-thumb{width:56px;height:56px;border-radius:8px;object-fit:cover}
  </style>
</head>
<body>

  <div id="loginScreen" class="login-wrap" aria-hidden="false">
    <div class="login" role="dialog" aria-label="Admin login">
      <h2>PUDDINGKU Admin</h2>
      <p class="muted">Masuk untuk mengelola pesanan, profit, dan tracking order.</p>
      <div class="form-row">
        <label>Username</label>
        <input id="username" type="text" value="" placeholder="admin">
      </div>
      <div class="form-row">
        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="loginBtn" class="btn">Login</button>
        <button id="demoBtn" class="btn ghost">Login Demo</button>
      </div>
      <p class="muted" style="margin-top:12px;font-size:12px">Credentials demo: <strong>admin</strong> / <strong>puddingku123</strong></p>
    </div>
  </div>

  <div id="app" class="app" style="display:none">
    <aside class="sidebar">
      <div class="brand">
        <div class=""><span></span></div>
        <img src="gambar/bg/logo.png" width="50" height="50" alt="logo">
        <div>
          <h1>UMKM PUDDINGKU</h1>
          <p>Admin Dashboard</p>
        </div>
      </div>
      <nav>
        <a href="#" class="active" data-section="dashboard">Dashboard</a>
        <a href="#" data-section="orders">Daftar Pesanan</a>
        <a href="#" data-section="products">Produk (demo)</a>
        <a href="#" data-section="settings">Pengaturan</a>
        <a href="#" id="logoutLink">Logout</a>
      </nav>
      <div style="position:absolute;bottom:20px;left:20px;right:20px">
        <div class="muted">Version demo • static</div>
      </div>
    </aside>

    <main class="main">
      <div class="header">
        <div class="header-left">
          <input id="search" class="search" placeholder="Cari pesanan atau pelanggan...">
        </div>
        <div class="user">
          <div style="text-align:right;margin-right:8px">
            <div class="muted">Halo, Admin</div>
            <div style="font-weight:700">Puddingku</div>
          </div>
          <div class=""></div>
          <img src="gambar/bg/logo admin.png" width="50px" height="50px" alt="admin-logo">
        </div>
      </div>

      <!-- dashboard -->
      <section id="section-dashboard">
        <div class="row">
          <div class="card" style="flex:2">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="muted">Ringkasan Hari Ini</div>
                <h2 id="todayOrders">0 Pesanan</h2>
                <div class="muted">Total profit: <strong id="todayProfit">Rp0</strong></div>
              </div>
              <div style="text-align:right">
                <div class="muted">Total profit (semua waktu)</div>
                <div style="font-weight:700;font-size:22px;margin-top:6px"> <span id="totalProfit">Rp0</span></div>
                <div style="margin-top:8px"><button id="exportBtn" class="btn ghost">Export JSON</button></div>
              </div>
            </div>

            <div style="margin-top:16px">
              <h3 style="margin:0">Pesanan terbaru</h3>
              <table class="table" id="recentTable">
                <thead>
                  <tr><th>No</th><th>Pelanggan</th><th>Items</th><th>Total</th><th>Status</th><th>Aksi</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div style="width:320px;display:flex;flex-direction:column;gap:12px">
            <div class="card">
              <div class="kpi"><div>
                <div class="title">Pesanan Pending</div>
                <div class="value" id="cntPending">0</div>
              </div><div style="font-size:12px;color:var(--muted)">Update otomatis</div></div>
            </div>
            <div class="card">
              <div class="kpi"><div>
                <div class="title">Sedang Diproses</div>
                <div class="value" id="cntPrep">0</div>
              </div><div style="font-size:12px;color:var(--muted)">Status</div></div>
            </div>
            <div class="card">
              <div class="kpi"><div>
                <div class="title">Terkirim</div>
                <div class="value" id="cntShip">0</div>
              </div><div style="font-size:12px;color:var(--muted)">Selesai</div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- orders -->
      <section id="section-orders" style="display:none">
        <div class="card">
          <h3>Daftar Pesanan</h3>
          <div style="margin-top:10px">
            <table class="table" id="ordersTable">
              <thead>
                <tr><th>No</th><th>Waktu</th><th>Pelanggan</th><th>Items</th><th>Total</th><th>Status</th><th>Tracking</th><th>Aksi</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- products (demo) -->
      <section id="section-products" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Produk (demo)</h3>
            <div>
              <button id="addProductTop" class="btn">+ Tambah Produk</button>
            </div>
          </div>
          <div class="muted" style="margin-top:8px">Daftar produk; tambah/edit/hapus akan tersimpan di browser (localStorage).</div>

          <div style="margin-top:12px;overflow:auto">
            <table class="table" id="productTable">
              <thead>
                <tr><th>No</th><th>Gambar</th><th>Nama</th><th>Harga</th><th>Stok</th><th>Deskripsi</th><th>Status</th><th>Aksi</th></tr>
              </thead>
              <tbody id="productTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>


      <section id="section-settings" style="display:none">
        <div class="card p-4 setting-wrapper" style="background: rgba(255,255,255,0.03); backdrop-filter: blur(8px); border-radius: 16px; border: 1px solid rgba(255,255,255,0.08);">

    <h3 class="mb-4">Pengaturan</h3>

    <div class="settings-layout">
        <!-- SIDE MINI MENU -->
        <div class="settings-menu">
            <button class="setting-tab active" data-target="general">Pengaturan Umum</button>
            <button class="setting-tab" data-target="account">Pengaturan Akun & Admin</button>
            <button class="setting-tab" data-target="product">Pengaturan Produk / Layanan</button>
            <button class="setting-tab" data-target="payment">Pengaturan Pembayaran</button>
            <button class="setting-tab" data-target="shipping">Pengaturan Pengiriman</button>
            <button class="setting-tab" data-target="appearance">Pengaturan Tampilan</button>
            <button class="setting-tab" data-target="notification">Pengaturan Notifikasi</button>
            <button class="setting-tab" data-target="analytics">Pengaturan Analitik & Laporan</button>
        </div>

        <!-- CONTENT -->
        <div class="settings-content">

            <div class="content-item active" id="general">
                <h4>Pengaturan Umum</h4>
                <p>Atur nama UMKM, logo, lokasi & jam operasional.</p>
                <label>Nama UMKM</label>
                <input class="form-control" id="setting_shop_name" placeholder="Contoh: Puddingku">
                <br>
                <label>Jam Operasional</label>
                <input class="form-control" id="setting_open_time" type="time">
            </div>

            <div class="content-item" id="account">
                <h4>Pengaturan Akun & Admin</h4>
                <p>Kelola akun admin & ubah password.</p>
                <button class="btn btn-primary btn-sm" id="addAdminBtn">Tambah Admin</button>
            </div>

            <div class="content-item" id="product">
                <h4>Pengaturan Produk / Layanan</h4>
                <p>Tambah, edit & hapus produk (sama dengan halaman Produk).</p>
                <button class="btn btn-success btn-sm" id="addProductSettingsBtn">Tambah Produk</button>
            </div>

            <div class="content-item" id="payment">
                <h4>Pengaturan Pembayaran</h4>
                <p>Atur metode pembayaran (E-wallet, Transfer Bank, COD).</p>
            </div>

            <div class="content-item" id="shipping">
                <h4>Pengaturan Pengiriman</h4>
                <p>Atur metode pengiriman & biaya ongkir.</p>
            </div>

            <div class="content-item" id="appearance">
                <h4>Pengaturan Tampilan</h4>
                <p>Kustom tema warna & brand style.</p>
                <div style="margin-top:8px">
                  <label style="display:flex;align-items:center;gap:10px">
                    <input type="checkbox" id="themeToggle"> Gunakan Mode Gelap
                  </label>
                </div>
            </div>

            <div class="content-item" id="notification">
                <h4>Pengaturan Notifikasi</h4>
                <p>Konfigurasi notifikasi WhatsApp / Email.</p>
            </div>

            <div class="content-item" id="analytics">
                <h4>Pengaturan Analitik & Laporan</h4>
                <p>Laporan penjualan & statistik performa.</p>
            </div>

            <hr>
            <button id="resetData" class="btn btn-danger btn-sm mt-2">
                Reset Data Demo
            </button>
        </div>
    </div>
</div>

<script>
const tabs = document.querySelectorAll(".setting-tab");
const content = document.querySelectorAll(".content-item");

tabs.forEach(tab => {
    tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        content.forEach(c => c.classList.remove("active"));

        tab.classList.add("active");
        document.getElementById(tab.dataset.target).classList.add("active");
    });
});
</script>
      </section>

    </main>

    <aside id="drawer" class="drawer" aria-hidden="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Detail Pesanan</h3>
        <button id="closeDrawer" class="btn ghost">Tutup</button>
      </div>
      <div id="drawerContent" style="margin-top:8px"></div>
    </aside>
  </div>

  <!-- PRODUCT MODAL -->
  <div id="productModal" aria-hidden="true">
    <div class="modal-inner">
      <h3 id="productModalTitle">Tambah Produk</h3>
      <div style="margin-top:10px">
        <label>Nama Produk</label>
        <input type="text" id="prod_name" />
      </div>
      <div style="margin-top:8px" class="form-row-inline">
        <div class="col">
          <label>Harga (angka)</label>
          <input type="text" id="prod_price" />
        </div>
        <div class="col">
          <label>Stok (angka)</label>
          <input type="text" id="prod_stock" />
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Deskripsi</label>
        <textarea id="prod_desc" rows="3"></textarea>
      </div>
      <div style="margin-top:8px">
        <label>URL Gambar (opsional)</label>
        <input type="text" id="prod_img" placeholder="https://..." />
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="saveProductBtn" class="btn">Simpan</button>
        <button id="cancelProductBtn" class="btn ghost">Batal</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Demo data & persistence ---------- */
    const DEMO_USER = {username:'admin', password:'puddingku123'};
    const SAMPLE_ORDERS = [
      {id: 'PUD-1001', created: '2025-11-07 09:12', customer: 'Siti', phone: '081234567890', items:[{name:'Pudding Coklat', qty:2, price:12000},{name:'Pudding Keju', qty:1, price:15000}], total:39000, profit:15000, status:'pending', tracking:'Menunggu konfirmasi'},
      {id: 'PUD-1002', created: '2025-11-07 10:40', customer: 'Budi', phone: '082233445566', items:[{name:'Pudding Matcha', qty:3, price:10000}], total:30000, profit:12000, status:'prep', tracking:'Sedang dikemas'},
      {id: 'PUD-1003', created: '2025-11-06 18:22', customer: 'Rina', phone: '081398765432', items:[{name:'Pudding Oreo', qty:1, price:13000}], total:13000, profit:5000, status:'ship', tracking:'Dalam pengiriman'}
    ];

    function readData(){
      const raw = localStorage.getItem('puddingku_data');
      if(!raw){
        const seed = {orders:SAMPLE_ORDERS, products:[
          {id: Date.now()+1, name:'Pudding Coklat', price:12000, stock:15, desc:'Pudding coklat lembut', img:'', status:'Aktif'},
          {id: Date.now()+2, name:'Pudding Keju', price:15000, stock:8, desc:'Pudding dengan topping keju', img:'', status:'Aktif'},
          {id: Date.now()+3, name:'Pudding Matcha', price:10000, stock:20, desc:'Pudding rasa matcha', img:'', status:'Aktif'},
          {id: Date.now()+4, name:'Pudding Oreo', price:13000, stock:10, desc:'Pudding oreo crunchy', img:'', status:'Aktif'}
        ]};
        localStorage.setItem('puddingku_data', JSON.stringify(seed));
        return seed;
      }
      try{
        const parsed = JSON.parse(raw);

        // normalize old-style products (string-only) into objects
        if(Array.isArray(parsed.products)){
          parsed.products = parsed.products.map((p,idx)=>{
            if(typeof p === 'string') return {id: Date.now()+idx, name:p, price:0, stock:0, desc:'', img:'', status:'Aktif'};
            // if object missing fields, fill defaults
            return {
              id: p.id || (Date.now()+idx),
              name: p.name || '',
              price: typeof p.price === 'number' ? p.price : (p.price ? Number(p.price)||0 : 0),
              stock: typeof p.stock === 'number' ? p.stock : (p.stock ? Number(p.stock)||0 : 0),
              desc: p.desc || p.description || '',
              img: p.img || '',
              status: p.status || 'Aktif'
            };
          });
        } else {
          parsed.products = [];
        }
        return parsed;
      }catch(e){localStorage.removeItem('puddingku_data');return readData();}
    }
    function saveData(data){localStorage.setItem('puddingku_data', JSON.stringify(data));}

    let state = readData();

    /* ---------- Auth ---------- */
    function showApp(){document.getElementById('loginScreen').style.display='none';document.getElementById('app').style.display='grid';renderAll();}
    function logout(){localStorage.removeItem('puddingku_admin_auth');location.reload();}
    document.getElementById('logoutLink').addEventListener('click', (e)=>{e.preventDefault();logout();});

    // login handlers
    document.getElementById('loginBtn').addEventListener('click', ()=>{
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value.trim();
      if(u===DEMO_USER.username && p===DEMO_USER.password){
        localStorage.setItem('puddingku_admin_auth', JSON.stringify({user:u, ts:Date.now()}));
        showApp();
      } else {alert('Credentials salah. Untuk demo gunakan admin / puddingku123')}
    });
    document.getElementById('demoBtn').addEventListener('click', ()=>{document.getElementById('username').value='admin';document.getElementById('password').value='puddingku123';document.getElementById('loginBtn').click();});

    // auto-login if already auth
    if(localStorage.getItem('puddingku_admin_auth')){
      showApp();
    }

    /* ---------- Navigation ---------- */
    document.querySelectorAll('nav a[data-section]').forEach(a=>a.addEventListener('click', (e)=>{
      e.preventDefault();document.querySelectorAll('nav a').forEach(x=>x.classList.remove('active'));a.classList.add('active');const sec=a.dataset.section;document.querySelectorAll('main section').forEach(s=>s.style.display='none');document.getElementById('section-'+sec).style.display='block';
      // close drawer if open
      closeDrawer();
    }));

    /* ---------- Rendering ---------- */
    function formatRupiah(n){ if(n==null) n=0; return 'Rp'+n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')}
    function calcCounts(){
      const orders = state.orders||[];
      const cntPending = orders.filter(o=>o.status==='pending').length;
      const cntPrep = orders.filter(o=>o.status==='prep').length;
      const cntShip = orders.filter(o=>o.status==='ship').length;
      const today = new Date().toISOString().slice(0,10);
      const todayOrders = orders.filter(o=>o.created && o.created.startsWith(today));
      const totalProfit = orders.reduce((s,o)=>s+(o.profit||0),0);
      const todayProfit = todayOrders.reduce((s,o)=>s+(o.profit||0),0);
      document.getElementById('cntPending').innerText=cntPending;
      document.getElementById('cntPrep').innerText=cntPrep;
      document.getElementById('cntShip').innerText=cntShip;
      document.getElementById('totalProfit').innerText=formatRupiah(totalProfit);
      document.getElementById('todayProfit').innerText=formatRupiah(todayProfit);
      document.getElementById('todayOrders').innerText=(todayOrders.length)+' Pesanan';
    }

    function renderRecent(){
      const tbody = document.querySelector('#recentTable tbody');tbody.innerHTML='';
      const orders = (state.orders||[]).slice().reverse().slice(0,6);
      orders.forEach((o,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${o.customer}</td><td>${o.items.length}</td><td>${formatRupiah(o.total)}</td><td><span class="status ${o.status}">${o.status.toUpperCase()}</span></td><td><div class="order-actions"><button class="btn ghost" data-id="${o.id}" data-action="view">Lihat</button></div></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderOrdersTable(){
      const tbody = document.querySelector('#ordersTable tbody');tbody.innerHTML='';
      (state.orders||[]).forEach((o,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${idx+1}</td><td>${o.created}</td><td>${o.customer}<div class="muted">${o.phone||''}</div></td><td>${o.items.map(it=>it.name+' x'+it.qty).join('<br>')}</td><td>${formatRupiah(o.total)}</td><td><span class="status ${o.status}">${o.status.toUpperCase()}</span></td><td><select data-id="${o.id}" class="trackingSelect"><option>Menunggu konfirmasi</option><option>Sedang dikemas</option><option>Dalam pengiriman</option><option>Selesai</option></select></td><td><button class="btn" data-id="${o.id}" data-action="view">Detail</button></td>`;
        tbody.appendChild(tr);
      });
      // set selects and attach listeners
      document.querySelectorAll('.trackingSelect').forEach(sel=>{
        const id=sel.dataset.id; const o=state.orders.find(x=>x.id===id);
        if(o) sel.value=o.tracking||'Menunggu konfirmasi';
        sel.addEventListener('change', (e)=>{ const val=e.target.value; const order=state.orders.find(x=>x.id===id); if(order){order.tracking=val; if(val==='Selesai'){order.status='ship'} else if(val==='Sedang dikemas'){order.status='prep'} else if(val==='Menunggu konfirmasi'){order.status='pending'} else {order.status='prep'}; saveData(state); renderAll(); alert('Tracking diubah: '+id+' → '+val);} });
      });

      // view buttons
      document.querySelectorAll('button[data-action="view"]').forEach(b=>b.addEventListener('click', (e)=>{const id=b.dataset.id;openDrawer(id);}));
    }

    /* ---------- Products: render product table in section-products ---------- */
    function renderProducts(){
      // this one used by dashboard older code: keep it for compatibility
      const ul=document.getElementById('productList'); if(ul) { ul.innerHTML=''; (state.products||[]).forEach(p=>{const li=document.createElement('li');li.textContent=p.name;ul.appendChild(li);}); }
      // render table
      const tbody = document.getElementById('productTableBody'); if(!tbody) return;
      tbody.innerHTML = '';
      (state.products||[]).forEach((p, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${p.img ? `<img class="product-thumb" src="${p.img}" alt="img">` : '-'}</td>
          <td>${escapeHtml(p.name)}</td>
          <td>${formatRupiah(p.price)}</td>
          <td>${p.stock}</td>
          <td style="max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(p.desc||'')}</td>
          <td>${p.status || 'Aktif'}</td>
          <td class="product-actions">
            <button class="btn ghost" data-action="edit" data-id="${p.id}">Edit</button>
            <button class="btn" data-action="delete" data-id="${p.id}">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderRecentTableForDashboard(){renderRecent();}

    function renderAll(){calcCounts();renderRecentTableForDashboard();renderOrdersTable();renderProducts();}

    /* ---------- Drawer (order detail) ---------- */
    const drawer=document.getElementById('drawer');
    function openDrawer(id){const order=(state.orders||[]).find(o=>o.id===id);if(!order) return;drawer.classList.add('open');drawer.setAttribute('aria-hidden','false');const content=document.getElementById('drawerContent');content.innerHTML='';
      const html = [];
      html.push('<div class="muted">ID: '+order.id+'</div>');
      html.push('<h3>'+order.customer+'</h3>');
      html.push('<div class="muted">'+order.created+'</div>');
      html.push('<div style="margin-top:8px"><strong>Items</strong><ul>');
      order.items.forEach(it=>{html.push('<li>'+escapeHtml(it.name)+' x'+it.qty+' — '+formatRupiah(it.price*it.qty)+'</li>')});
      html.push('</ul></div>');
      html.push('<div style="margin-top:8px"><strong>Total: </strong>'+formatRupiah(order.total)+'</div>');
      html.push('<div style="margin-top:8px"><label class="muted">Status</label><select id="statusSelect"><option value="pending">Pending</option><option value="prep">Prep</option><option value="ship">Ship</option><option value="cancel">Cancel</option></select></div>');
      html.push('<div style="margin-top:8px"><label class="muted">Tracking</label><input id="trackingInput" value="'+escapeHtml(order.tracking||'')+'"/></div>');
      html.push('<div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="saveOrderBtn" class="btn">Simpan</button><button id="deleteOrderBtn" class="btn ghost">Hapus</button></div>');
      content.innerHTML=html.join('');
      document.getElementById('statusSelect').value=order.status;
      document.getElementById('saveOrderBtn').addEventListener('click', ()=>{order.status=document.getElementById('statusSelect').value;order.tracking=document.getElementById('trackingInput').value;saveData(state);renderAll();alert('Perubahan disimpan.');});
      document.getElementById('deleteOrderBtn').addEventListener('click', ()=>{if(confirm('Hapus pesanan '+order.id+'?')){state.orders=state.orders.filter(x=>x.id!==order.id);saveData(state);renderAll();closeDrawer();}});
    }
    function closeDrawer(){drawer.classList.remove('open');drawer.setAttribute('aria-hidden','true');}
    document.getElementById('closeDrawer').addEventListener('click', closeDrawer);

    /* ---------- Search ---------- */
    document.getElementById('search').addEventListener('input', (e)=>{const q=e.target.value.trim().toLowerCase(); if(!q){renderOrdersTable();return;} const tbody=document.querySelector('#ordersTable tbody');tbody.innerHTML=''; (state.orders||[]).filter(o=>o.customer.toLowerCase().includes(q) || o.id.toLowerCase().includes(q) || (o.phone||'').includes(q)).forEach((o,idx)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${idx+1}</td><td>${o.created}</td><td>${o.customer}<div class="muted">${o.phone||''}</div></td><td>${o.items.map(it=>it.name+' x'+it.qty).join('<br>')}</td><td>${formatRupiah(o.total)}</td><td><span class="status ${o.status}">${o.status.toUpperCase()}</span></td><td>${o.tracking||''}</td><td><button class="btn" data-id="${o.id}" data-action="view">Detail</button></td>`;tbody.appendChild(tr);});
      document.querySelectorAll('button[data-action="view"]').forEach(b=>b.addEventListener('click', (e)=>{openDrawer(b.dataset.id);}));
    });

    /* ---------- Export / reset ---------- */
    document.getElementById('exportBtn').addEventListener('click', ()=>{const data = JSON.stringify(state, null, 2);const blob=new Blob([data],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='puddingku_data.json';a.click();URL.revokeObjectURL(url);});

    // resetData button (exists now)
    document.getElementById('resetData').addEventListener('click', ()=>{if(confirm('Reset data demo ke keadaan awal?')){localStorage.removeItem('puddingku_data');localStorage.removeItem('puddingku_theme');state=readData();applyThemeFromStorage();renderAll();alert('Reset selesai.')}});

    /* ---------- Product modal & actions ---------- */
    const productModal = document.getElementById('productModal');
    const prodName = document.getElementById('prod_name');
    const prodPrice = document.getElementById('prod_price');
    const prodStock = document.getElementById('prod_stock');
    const prodDesc = document.getElementById('prod_desc');
    const prodImg = document.getElementById('prod_img');
    const saveProductBtn = document.getElementById('saveProductBtn');
    const cancelProductBtn = document.getElementById('cancelProductBtn');
    let editingProductId = null;

    // open modal helper
    function openProductModal(product){
      productModal.style.display='flex';
      productModal.setAttribute('aria-hidden','false');
      if(product){
        editingProductId = product.id;
        document.getElementById('productModalTitle').innerText = 'Edit Produk';
        prodName.value = product.name || '';
        prodPrice.value = product.price || 0;
        prodStock.value = product.stock || 0;
        prodDesc.value = product.desc || '';
        prodImg.value = product.img || '';
      } else {
        editingProductId = null;
        document.getElementById('productModalTitle').innerText = 'Tambah Produk';
        prodName.value=''; prodPrice.value=''; prodStock.value=''; prodDesc.value=''; prodImg.value='';
      }
    }
    function closeProductModal(){
      productModal.style.display='none';
      productModal.setAttribute('aria-hidden','true');
      editingProductId = null;
    }
    document.getElementById('addProductTop').addEventListener('click', ()=>openProductModal());
    const addProductSettingsBtn = document.getElementById('addProductSettingsBtn');
    if(addProductSettingsBtn) addProductSettingsBtn.addEventListener('click', ()=>openProductModal());

    cancelProductBtn.addEventListener('click', ()=>closeProductModal());

    saveProductBtn.addEventListener('click', ()=>{
      const name = prodName.value.trim(); const price = Number(prodPrice.value)||0; const stock = Number(prodStock.value)||0; const desc = prodDesc.value.trim(); const img = prodImg.value.trim();
      if(!name){alert('Nama produk diperlukan'); return;}
      if(editingProductId){
        // update
        const p = (state.products||[]).find(x=>x.id===editingProductId);
        if(p){p.name=name; p.price=price; p.stock=stock; p.desc=desc; p.img=img; p.status = p.stock>0 ? 'Aktif' : 'Habis';}
      } else {
        const newProd = {id: Date.now(), name, price, stock, desc, img, status: stock>0 ? 'Aktif' : 'Habis'};
        state.products.push(newProd);
      }
      saveData(state); renderProducts(); closeProductModal(); alert('Produk disimpan.');
    });

    // delegate edit/delete buttons in product table
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const action = btn.dataset.action;
      const id = Number(btn.dataset.id);
      if(action === 'edit'){
        const p = (state.products||[]).find(x=>x.id===id);
        if(p) openProductModal(p);
      } else if(action === 'delete'){
        if(confirm('Hapus produk ini?')){
          state.products = (state.products||[]).filter(x=>x.id!==id);
          saveData(state); renderProducts();
        }
      }
    });

    /* ---------- theme (dark/light) ---------- */
    const themeToggle = document.getElementById('themeToggle');
    const applyThemeFromStorage = ()=>{
      const t = localStorage.getItem('puddingku_theme') || 'dark';
      if(t === 'light'){ document.body.classList.add('light'); themeToggle.checked = false; } else { document.body.classList.remove('light'); themeToggle.checked = true; }
    };
    // store: 'dark' (default) or 'light'
    applyThemeFromStorage();
    themeToggle.addEventListener('change', ()=>{
      if(themeToggle.checked){
        // checked = dark
        localStorage.setItem('puddingku_theme','dark');
        document.body.classList.remove('light');
      } else {
        localStorage.setItem('puddingku_theme','light');
        document.body.classList.add('light');
      }
    });

    /* ---------- Init attach events for recent view buttons (delegation) ---------- */
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action]'); if(!btn) return; const action=btn.dataset.action; const id=btn.dataset.id; if(action==='view') openDrawer(id);
    });

    /* ---------- utility escape html ---------- */
    function escapeHtml(unsafe) {
      if(!unsafe && unsafe!==0) return '';
      return String(unsafe).replace(/[&<>"'`=\/]/g, function (s) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '/': '&#x2F;',
          '`': '&#x60;',
          '=': '&#x3D;'
        })[s];
      });
    }

    /* ---------- export for debugging ---------- */
    window._puddingku_state = state;

    // initial render already handled by showApp when authed or after login
  </script>
</body>
</html>
